name: Container Image CI
on: [push]
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      GHCR: ghcr.io
      IMAGE_NAME: example-node-webapp
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Scan current project directory with Grype
      id: scan_directory
      uses: anchore/scan-action@v2
      with:
        path: "./"
        fail-build: true
        severity-cutoff: critical

    - name: upload grype directory scan report
      uses: actions/upload-artifact@v2
      with:
        name: grype-directory-vuln-report
        path: ${{ steps.scan_directory.outputs.vulnerabilities }}
        retention-days: 1
    
    - name: Build image from Dockerfile
      id: build_image
      run: |
        chmod +x scripts/*
        mkdir -p artifacts
        ./scripts/metadata.py
        ./scripts/build-image.sh

    - name: Scan built image with Grype
      id: scan_image
      uses: anchore/scan-action@v2
      with:
        image: "localbuild/example-node-webapp:latest"
        fail-build: false
        severity-cutoff: critical
    
    - name: upload grype image scan report
      uses: actions/upload-artifact@v2
      with:
        name: grype-image-vuln-report
        path: ${{ steps.scan_image.outputs.vulnerabilities }}
        retention-days: 1

    - name: Login to GitHub Container Registry
      id: ghcr_login
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: Push image to GitHub Container Registry
      id: ghcr_push
      run: |
        docker push "ghcr.io/${GITHUB_ACTOR}/${IMAGE_NAME}:latest"
        docker push "ghcr.io/${GITHUB_ACTOR}/${IMAGE_NAME}:${GITHUB_SHA}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Check out deployment code
      id: checkout_deployment_repo
      uses: actions/checkout@v2
      with:
        repository: 'valancej/compliance-deployment'
        token: ${{ secrets.REPO_PAT }}

    - name: Setup Kustomize
      id: setup_kustomize
      uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: "3.6.1"

    - name: Update Kubernetes resources
      id: update_k8s
      run: |
        cd kustomize/base
        kustomize edit set image example-webapp=ghcr.io/valancej/example-node-webapp:$GITHUB_SHA
        kustomize edit add annotation gitCommit:$GITHUB_SHA --force
        cat kustomization.yaml
        kustomize build

    - name: Commit files
      id: commit_changes
      run: |
        git config --local user.name "valancej"
        git add .
        git commit -m "Image bump"
        git push